# dataverse-client

[![License](https://img.shields.io/badge/license-MIT-brightgreen)](LICENSE)
![Code Style](https://img.shields.io/badge/code%20style-black-black)
[![semantic-release: angular](https://img.shields.io/badge/semantic--release-angular-e10079?logo=semantic-release)](https://github.com/semantic-release/semantic-release)
![Interrogate](https://img.shields.io/badge/interrogate-100.0%25-brightgreen)
![Coverage](https://img.shields.io/badge/coverage-100%25-brightgreen)
![Python](https://img.shields.io/badge/python->=3.10-blue?logo=python)

## Usage

- Save a configuration file to `C:\ProgramData\AllenInstitute\dataverse_client\config.yml` containing `tenant_id`, `client_id`, and `org` strings.
- `set DATAVERSE_username=<username>` and `set DATAVERSE_password=<password>` to set environment variables with the account credentials used to access dataverse
    - The other config settings can also be set through environment variables prefixed with "DATAVERSE_", e.g. `DATAVERSE_tenant_id`. 

```python
config = DataverseConfig() # instantiating config reads from yaml file and env vars
client = DataverseRestClient(config)

entry = client.get_entry(table, entry_id)
```

## REST API and Queries

URLs are formatted like `https://<ORG_ID>.crm.dynamics.com/api/data/v9.2/<TABLE><QUERY>`

To fetch an entity by its primary key: `https://<ORG_ID>.crm.dynamics.com/api/data/v9.2/<TABLE>({entry_primary_id})`
To fetch an entity by an alternate key: `https://<ORG_ID>.crm.dynamics.com/api/data/v9.2/<TABLE>({alt_key_name}={entry_primary_id})`
    - Note: string values must include single quotes: e.g. `(mouse_id='123456')`

To filter and query: 
- [odata query docs](https://docs.oasis-open.org/odata/odata/v4.0/errata03/os/complete/part1-protocol/odata-v4.0-errata03-os-part1-protocol-complete.html#_The_$filter_System)
- `https://<ORG_ID>.crm.dynamics.com/api/data/v9.2/<TABLE>?$filter=contains(crb81_mouse_id, 614)`
- `https://<ORG_ID>.crm.dynamics.com/api/data/v9.2/<TABLE>?$filter=crb81_sex eq 0`

## Dataverse setup

In order to write to table
Set up security role at admin.powerplatform.microsoft.com - Environment - Settings -Security Roles
Assign the role to svc_sipe account

Important:
Primary Column is NOT actual primary key - that's the autogenerated guid column `<tablename>_baseid`
Had to add Alternate Key (make.powerapps - table - Schema - Keys)
  Alternate key must be unique - will fail if duplicate values are found

For instance, the dim_mice table has a dim_mice_baseid column with uids, but we'd like to refer to mice by their 6-7 digit mouse_id. This table should be given an Alternate Key for the mouse_id column, so you can refer to a mouse with `(mouse_id='614173')`

## Level of Support
Please indicate a level of support:
 - [x] Supported: We are releasing this code to the public as a tool we expect others to use. Issues are welcomed, and we expect to address them promptly; pull requests will be vetted by our staff before inclusion.
 - [ ] Occasional updates: We are planning on occasional updating this tool with no fixed schedule. Community involvement is encouraged through both issues and pull requests.
 - [ ] Unsupported: We are not currently supporting this code, but simply releasing it to the community AS IS but are not able to provide any guarantees of support. The community is welcome to submit issues, but you should not expect an active response.

## Installation
To use the software, in the root directory, run
```bash
pip install -e .
```

To develop the code, run
```bash
pip install -e .[dev]
```
